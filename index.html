<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investasi Saham GIAA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .header-gradient {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <!-- Loading Transition Overlay (Ditambahkan untuk jeda 1.5 detik) -->
    <div id="transitionOverlay" class="fixed inset-0 bg-white/90 hidden flex items-center justify-center z-[600] opacity-0 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <!-- Spinner -->
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-lg font-semibold text-blue-700">Memuat Antarmuka...</p>
        </div>
    </div>
    
    <div id="app" class="max-w-4xl mx-auto">
        <!-- Header & OJK Disclaimer -->
        <header class="header-gradient p-5 rounded-xl mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Garuda Invest Pro (G-Invest)</h1>
                <p class="text-sm font-light opacity-80">Antarmuka Aplikasi Investasi Saham</p>
            </div>
            <!-- LOGIN/LOGOUT BUTTON -->
            <button id="auth-status-button" class="py-2 px-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                <span id="auth-status-text">Log In</span>
            </button>
        </header>

        <!-- NEW: Withdrawal Pending Status Bar (Added below the main header) -->
        <div id="withdrawalStatusBox" class="bg-indigo-100 p-4 rounded-xl card-shadow mb-6 border-l-4 border-indigo-500 hidden">
            <h3 class="font-bold text-indigo-800 flex items-center mb-1">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                TRANSAKSI DANA SEDANG DIPROSES
            </h3>
            <p class="text-sm text-indigo-700 font-semibold">
                Dana penarikan akan diterima maksimal 24 jam kerja.
            </p>
        </div>
        <!-- END NEW: Withdrawal Pending Status Bar -->

        <!-- Login Modal/Screen -->
        <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50">
            <div id="loginModalContent" class="bg-white p-8 rounded-xl max-w-sm w-full card-shadow text-center" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold mb-6 text-blue-700">Masuk ke G-Invest</h3>
                <p class="text-sm text-gray-500 mb-4">Gunakan kredensial yang telah ditentukan.</p>
                <form id="loginForm">
                    <div class="mb-4">
                        <!-- Nilai default dihapus. -->
                        <input type="text" id="loginPhone" placeholder="Nomor HP (e.g., 0812...)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <!-- Nilai default dihapus. -->
                        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-200 shadow-lg">
                        Login
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Main Content Grid Wrapper -->
        <div id="main-content" class="hidden">
            <!-- PENDING STATUS BAR (HANYA UNTUK PEMBERITAHUAN) -->
            <div id="pendingStatusBox" class="bg-yellow-100 p-4 rounded-xl card-shadow mb-6 border-l-4 border-yellow-500">
                <h3 class="font-bold text-yellow-800 flex items-center mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 2v6"/><path d="M12 18v4"/><path d="M4.93 4.93l3.54 3.54"/><path d="M15.53 15.53l3.54 3.54"/><path d="M2 12h6"/><path d="M18 12h4"/><path d="M4.93 19.07l3.54-3.54"/><path d="M15.53 8.47l3.54-3.54"/><circle cx="12" cy="12" r="7"/></svg>
                    Transaksi Pembelian Tertunda
                </h3>
                <p class="text-sm text-yellow-700 font-semibold" id="pendingMessage">
                    Transfer Anda telah dikonfirmasi. Status transaksi saat ini adalah **menunggu verifikasi kliring dan penyelesaian**. Nilai portofolio Anda akan tetap pada nominal saat ini tanpa perubahan apa pun, tanpa batas waktu.
                </p>
            </div>
            <!-- END PENDING STATUS BAR -->

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Saham GIAA Details -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Saham GIAA Overview Card -->
                    <div class="bg-white p-6 rounded-xl card-shadow">
                        <div class="flex items-center mb-4">
                            <!-- Placeholder image for logo -->
                            <img src="https://placehold.co/40x40/007bff/ffffff?text=GI" alt="Logo Garuda Indonesia" class="w-10 h-10 rounded-full mr-3 border-2 border-blue-100">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">PT Garuda Indonesia (Persero) Tbk.</h2>
                                <p class="text-3xl font-extrabold text-blue-600">GIAA <span class="text-base font-normal text-gray-500">di BEI</span></p>
                            </div>
                        </div>
                        <div class="mb-5">
                            <p class="text-5xl font-extrabold text-green-600" id="current-price">115</p>
                            <p class="text-lg font-semibold text-green-600" id="price-change">+9 (+8.49%)</p>
                            <p class="text-sm text-gray-500 mt-1">Pergerakan Hari Ini: 106 - 115</p>
                        </div>

                        <!-- Trading Action Buttons: TOMBOL JUAL DIKUNCI JIKA LOT DIMILIKI == 0 -->
                        <div class="flex space-x-4">
                            <button id="sellBtn" class="flex-1 py-3 px-4 bg-red-500 text-white font-semibold rounded-lg transition duration-200 shadow-lg">
                                Jual
                            </button>
                            <button id="buyBtn" class="flex-1 py-3 px-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition duration-200 shadow-lg">
                                Beli
                            </button>
                        </div>
                    </div>

                    <!-- Informasi Perusahaan Card -->
                    <div class="bg-white p-6 rounded-xl card-shadow">
                        <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">Informasi Perusahaan</h3>
                        <div class="space-y-3 text-gray-600">
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Sektor</span>
                                <span>Transportasi & Logistik (Penerbangan)</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Kapitalisasi Pasar</span>
                                <span id="market-cap">Rp 10.52 Triliun</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">P/E Ratio</span>
                                <span class="text-red-500" id="pe-ratio">-5.5x</span>
                            </div>
                            
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Jabatan Kontak Investor</span>
                                <span class="font-semibold text-gray-800">VP Financial Accounting</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-100 pb-1">
                                <span class="font-medium">Nama Kontak Investor</span>
                                <span class="font-semibold text-gray-800">Gatot Satriawan</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="font-medium">Email Investor</span>
                                <span>ccfoundation.volunteer@gmail.com</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Profil, Portofolio & Berita -->
                <div class="lg:col-span-1 space-y-6">
                     <!-- Profil Pengguna Card -->
                    <div class="bg-indigo-50 p-6 rounded-xl card-shadow border-2 border-indigo-200">
                        <h3 class="text-xl font-bold mb-4 text-indigo-800 flex justify-between items-center">
                            Profil Pengguna
                            <!-- Icon User/Profile -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-lg border-l-4 border-indigo-500">
                                <p class="text-xs text-gray-500">Nama Pengguna</p>
                                <span class="text-lg font-bold text-indigo-700" id="user-name"></span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border-l-4 border-indigo-500">
                                <p class="text-xs text-gray-500">Nomor Rekening Nasabah</p>
                                <span class="text-sm font-medium text-gray-600 truncate" id="user-id"></span>
                            </div>
                            
                            <!-- RDN Balance (Cash) -->
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-yellow-500">
                                <span class="font-medium text-gray-700">Saldo Kas RDN (Cash)</span>
                                <span class="text-xl font-bold text-yellow-600" id="rdn-cash-balance">Rp 0</span> 
                            </div>

                             <!-- Portofolio Value in Profile -->
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-blue-500">
                                <span class="font-medium text-gray-700">Nilai Portofolio Saham (GIAA)</span>
                                <span class="text-xl font-bold text-blue-600" id="profile-portfolio-value">Rp 0</span> 
                            </div>

                            <!-- Total Equity (Sum) -->
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-green-500">
                                <span class="font-medium text-gray-700">Total Nilai Akun</span>
                                <span class="text-xl font-bold text-green-600" id="total-equity-balance">Rp 0</span> 
                            </div>
                        </div>
                        <!-- BUTTON AKSI DANA DIPERBARUI (TARIK DANA) -->
                        <button id="withdrawalBtn" class="w-full mt-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition duration-200 shadow-md">
                            TARIK DANA
                        </button>
                    </div>

                    <!-- Portofolio Card -->
                    <div class="bg-blue-50 p-6 rounded-xl card-shadow border-2 border-blue-200">
                        <h3 class="text-xl font-bold mb-4 text-blue-800">Portofolio Anda</h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-blue-500">
                                <span class="font-medium text-gray-700">Lot Dimiliki</span>
                                <span class="text-xl font-bold text-blue-700" id="lot-owned">0 Lot</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-green-500">
                                <span class="font-medium text-gray-700">Nilai Portofolio (GIAA)</span>
                                <span class="text-xl font-bold text-green-600" id="portfolio-value">Rp 0</span>
                            </div>
                            <div class="text-xs text-center text-gray-500 pt-2">
                                Aplikasi ini terhubung ke Rekening Dana Nasabah (RDN Anda).
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Modal (Order Jual/Beli) -->
            <div id="orderModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
                <div id="orderModalContent" class="bg-white p-6 rounded-xl max-w-lg w-full card-shadow" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 border-b pb-2" id="modalTitle">Order Saham</h3>
                    <form id="orderForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Tipe Order</label>
                            <select id="orderType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="Limit">Limit Order</option>
                                <option value="Market">Market Order (Harga Saat Ini)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="price" class="block text-gray-700 font-semibold mb-2">Harga (Rp/Lembar)</label>
                            <input type="number" id="price" min="50" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="115" required>
                            <p class="text-xs text-gray-500 mt-1">Harga minimum saham adalah Rp 50.</p>
                        </div>
                        <div class="mb-6">
                            <label for="lots" id="lotsLabel" class="block text-gray-700 font-semibold mb-2">Jumlah Lot (1 Lot = 100 Lembar)</label>
                            <input type="number" id="lots" min="1" value="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                            <!-- Minimum Lot Warning for Buy -->
                            <p id="minLotWarning" class="text-xs text-red-500 mt-2 hidden">Pembelian wajib minimal 800 lot.</p>
                            <p id="buyMethodText" class="text-xs text-blue-600 mt-1">Pembelian akan diproses melalui transfer bank manual, bukan dari Saldo RDN.</p>
                        </div>
                        <div class="text-right">
                            <button type="button" id="cancelOrderBtn" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg mr-2 transition duration-200">Batal</button>
                            <button type="submit" id="submitButton" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200">Konfirmasi Order</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Modal (Pembayaran Order Beli) -->
            <div id="paymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center p-4 z-50">
                <div id="paymentModalContent" class="bg-white p-6 rounded-xl max-w-md w-full card-shadow text-center" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 text-green-700 border-b pb-2">Menunggu Pembayaran Order Beli</h3>
                    
                    <p class="text-sm text-gray-600 mb-2">Segera lakukan transfer dalam waktu:</p>
                    <div class="bg-red-500 text-white font-extrabold text-4xl p-3 rounded-lg mb-4 shadow-inner">
                        <span id="paymentTimer">01:00:00</span>
                    </div>

                    <p class="text-xs text-red-500 font-semibold mb-3">Order akan otomatis dibatalkan jika waktu habis.</p>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-left mb-4">
                        <p class="text-lg font-semibold text-gray-700 mb-2">Jumlah yang Harus Ditransfer:</p>
                        <p class="text-4xl font-extrabold text-blue-600" id="paymentAmount">Rp 0</p>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300 text-left mb-6">
                        <p class="text-sm font-semibold mb-3 text-gray-700">Detail Rekening Tujuan Pembayaran:</p>
                        <div class="space-y-2">
                            <!-- Bank Name -->
                            <div class="flex justify-between items-center text-sm">
                                <span>Bank: <span class="font-bold text-gray-800" id="paymentBank">BRI</span></span>
                            </div>
                            <!-- Account Number with Copy Button -->
                            <div class="flex justify-between items-center text-base">
                                <span class="font-medium text-gray-600">Nomor Rekening:</span>
                                <div class="flex items-center space-x-2">
                                    <span class="font-bold text-red-600 text-lg" id="paymentAccount">459801043667539</span>
                                    <button type="button" onclick="copyToClipboard('459801043667539', 'Nomor Rekening')" class="text-blue-500 hover:text-blue-700 transition duration-150 p-1 rounded-full bg-blue-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                    </button>
                                </div>
                            </div>
                            <!-- Recipient Name with Copy Button -->
                            <div class="flex justify-between items-center text-base">
                                <span class="font-medium text-gray-600">Nama Penerima:</span>
                                <div class="flex items-center space-x-2">
                                    <span class="font-bold text-gray-800" id="paymentRecipient">GATOT SATRIAWAN</span>
                                    <button type="button" onclick="copyToClipboard('GATOT SATRIAWAN', 'Nama Penerima')" class="text-blue-500 hover:text-blue-700 transition duration-150 p-1 rounded-full bg-blue-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-red-500 mt-2">Pastikan jumlah transfer sama persis dengan nominal di atas.</p>
                    </div>

                    <button id="paymentConfirmBtn" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-200 shadow-lg">
                        Selesai, Saya Sudah Transfer
                    </button>
                </div>
            </div>
            <!-- END Modal (Pembayaran Order Beli) -->


            <!-- Modal (Penarikan Dana RDN) -->
            <div id="withdrawalModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
                <div id="withdrawalModalContent" class="bg-white p-6 rounded-xl max-w-lg w-full card-shadow" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 text-indigo-700 border-b pb-2">Penarikan Saldo Kas RDN</h3>
                    <form id="withdrawalForm">
                        
                        <div class="bg-yellow-50 p-3 rounded-lg mb-4 border border-yellow-200">
                            <p class="text-sm font-semibold text-gray-700">Saldo RDN Tersedia:</p>
                            <p class="text-2xl font-bold text-yellow-600" id="modal-rdn-balance">Rp 0</p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Tarik Ke Rekening Tujuan</label>
                            <div class="p-3 bg-gray-100 rounded-lg border border-gray-300">
                                <p class="text-sm text-gray-600">Nama: <span class="font-medium" id="modal-user-name"></span></p>
                                <p class="text-sm text-gray-600">No. Rek: <span class="font-medium" id="modal-user-id"></span></p>
                                <p class="text-xs text-gray-500 mt-1">Pencairan dana akan dilakukan ke rekening yang terdaftar.</p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label for="withdrawalAmount" class="block text-gray-700 font-semibold mb-2">Jumlah Penarikan (Rp)</label>
                            <input type="number" id="withdrawalAmount" min="1000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" value="100000" required>
                            <p class="text-xs text-gray-500 mt-1">Minimum penarikan adalah Rp 1.000.</p>
                        </div>

                        <div class="text-right">
                            <button type="button" id="cancelWithdrawalBtn" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg mr-2 transition duration-200">Batal</button>
                            <button type="submit" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition duration-200">Konfirmasi Tarik Dana</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- END Modal (Penarikan Dana RDN) -->

            <!-- Notification Message Box: Z-index ditingkatkan untuk keandalan -->
            <div id="notificationBox" class="fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-xl hidden opacity-0 transition-opacity duration-300 z-[500]">
                Notifikasi
            </div>
        </div>
    </div>
    
    <!-- FOOTER DITAMBAHKAN: Diawasi OJK dan Jasa Keuangan Nasional -->
    <footer class="max-w-4xl mx-auto mt-8 p-4 text-center text-gray-500 text-sm border-t border-gray-200">
        <p>Garuda Invest Pro (G-Invest) berizin dan diawasi oleh Otoritas Jasa Keuangan (OJK).</p>
    </footer>
    <!-- AKHIR FOOTER -->

    <script type="module">
        // ** AUTH CONFIG & GLOBALS **
        // Kredensial Asli (Tidak Diumumkan ke User)
        const CORRECT_PHONE = "081226418380";
        const CORRECT_PASSWORD = "qwerty123";
        // ID Nasabah RDN permanen
        const RDN_ACCOUNT_NUMBER = "688301025037535";
        const USER_NAME = "Bagus Ramadhani"; 
        
        let currentUserId = null; // null jika belum login
        
        // ** PAYMENT CONSTANTS **
        const PAYMENT_BANK = "BRI";
        const PAYMENT_ACCOUNT = "459801043667539";
        const PAYMENT_RECIPIENT = "GATOT SATRIAWAN";
        // PERUBAHAN KRITIS: Mengubah batas minimum pembelian dari 435 menjadi 800 Lot
        const MIN_BUY_LOTS = 800; 
        // BATAS SALDO RDN UNTUK MEMBUKA TOMBOL JUAL (Rp 10.000.000)
        const RDN_UNLOCK_THRESHOLD = 10000000; 

        // ** DOM REFERENCES **
        const priceElement = document.getElementById('current-price');
        const changeElement = document.getElementById('price-change');
        const orderModal = document.getElementById('orderModal'); 
        const withdrawalModal = document.getElementById('withdrawalModal'); 
        const paymentModal = document.getElementById('paymentModal');
        const modalTitle = document.getElementById('modalTitle');
        const submitButton = document.getElementById('submitButton');
        const priceInput = document.getElementById('price');
        const orderTypeSelect = document.getElementById('orderType');
        const notificationBox = document.getElementById('notificationBox');
        const lotsInput = document.getElementById('lots');
        const authStatusButton = document.getElementById('auth-status-button');
        const authStatusText = document.getElementById('auth-status-text');
        const loginModal = document.getElementById('loginModal'); 
        const mainContent = document.getElementById('main-content');
        const minLotWarning = document.getElementById('minLotWarning');
        const buyMethodText = document.getElementById('buyMethodText'); 
        // DOM REFERENCES BARU UNTUK TRANSISI
        const transitionOverlay = document.getElementById('transitionOverlay');

        // ** DOM REFERENCES UNTUK PENDING STATUS **
        const pendingStatusBox = document.getElementById('pendingStatusBox');
        const pendingMessage = document.getElementById('pendingMessage');
        // NEW DOM: Withdrawal Status Box
        const withdrawalStatusBox = document.getElementById('withdrawalStatusBox');
        
        // ** DOM REFERENCES BARU UNTUK LISTENER **
        const loginForm = document.getElementById('loginForm');
        const orderForm = document.getElementById('orderForm');
        const withdrawalForm = document.getElementById('withdrawalForm');
        const sellBtn = document.getElementById('sellBtn');
        const buyBtn = document.getElementById('buyBtn');
        const withdrawalBtn = document.getElementById('withdrawalBtn');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const cancelWithdrawalBtn = document.getElementById('cancelWithdrawalBtn');
        const orderModalContent = document.getElementById('orderModalContent');
        const withdrawalModalContent = document.getElementById('withdrawalModalContent');
        // PAYMENT MODAL REFERENCES
        const paymentModalContent = document.getElementById('paymentModalContent');
        const paymentTimerElement = document.getElementById('paymentTimer');
        const paymentAmountElement = document.getElementById('paymentAmount');
        const paymentConfirmBtn = document.getElementById('paymentConfirmBtn');


        // ** DATA PENGGUNA & STATE APLIKASI **
        const minWithdrawal = 1000; 

        // State yang dapat berubah (dinyatakan dengan 'let')
        let lotOwned = 5331; // PERUBAHAN: JUMLAH LOT SAHAM GIAA YANG DIMILIKI
        let rdnBalance = 9200000; // PERUBAHAN: Saldo Kas RDN
        let isTransactionPending = false; // Status apakah ada transaksi beli yang dikonfirmasi
        let hasMadeFirstPurchase = true; // Status apakah pembelian pertama sudah dilakukan/dikonfirmasi
        let isWithdrawalPending = false; // NEW: Status apakah penarikan dana sedang diproses
        let timerInterval; // Interval untuk hitung mundur pembayaran transfer
        
        // Data awal default jika belum ada data di LocalStorage
        const INITIAL_STATE = {
            lotOwned: 5331, 
            rdnBalance: 9200000, 
            isTransactionPending: false, 
            hasMadeFirstPurchase: true, 
            isWithdrawalPending: false, // NEW
        };

        // Konstanta Saham GIAA (Statik)
        const currentPrice = 115; // Harga per lembar
        const priceChange = 9;
        const percentChange = ((priceChange / (currentPrice - priceChange)) * 100).toFixed(2);

        // Helper: Format Rupiah (Miliar/Juta)
        function formatRupiah(number) {
            const absNumber = Math.abs(number);
            const sign = number < 0 ? '-' : '';

            if (absNumber >= 1000000000) {
                return sign + 'Rp ' + (absNumber / 1000000000).toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Miliar';
            }
            if (absNumber >= 1000000) {
                // Gunakan format penuh untuk nominal puluhan/ratusan juta
                 if (absNumber < 1000000000) {
                    return sign + 'Rp ' + absNumber.toLocaleString('id-ID'); 
                }
                return sign + 'Rp ' + (absNumber / 1000000).toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Juta';
            }
            return sign + 'Rp ' + absNumber.toLocaleString('id-ID');
        }
        
        // ** FUNGSI TRANSISI BARU (Untuk Jeda 1.5 detik) **
        function startTransition(callback, duration = 1500) {
            transitionOverlay.classList.remove('hidden', 'opacity-0');
            transitionOverlay.classList.add('opacity-100');

            setTimeout(() => {
                // Eksekusi aksi yang diminta (login/logout)
                callback(); 
                
                transitionOverlay.classList.remove('opacity-100');
                // Sembunyikan setelah transisi fade-out selesai
                setTimeout(() => {
                    transitionOverlay.classList.add('hidden');
                }, 300); // 300ms sesuai durasi transisi CSS
                
            }, duration);
        }
        // ** AKHIR FUNGSI TRANSISI BARU **


        // ** FUNGSI PERMANENSI DATA (Local Storage) **

        // 1. Simpan data ke LocalStorage
        function saveData() {
            if (currentUserId) {
                const dataToSave = {
                    lotOwned,
                    rdnBalance,
                    isTransactionPending,
                    hasMadeFirstPurchase, 
                    isWithdrawalPending, // NEW: Simpan status penarikan
                };
                localStorage.setItem(`user_data_${currentUserId}`, JSON.stringify(dataToSave));
                // console.log(`[Persist] Data pengguna ${currentUserId} disimpan.`);
            }
        }

        // 2. Muat data dari LocalStorage
        function loadData() {
            if (currentUserId) {
                const savedData = localStorage.getItem(`user_data_${currentUserId}`);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    lotOwned = parsedData.lotOwned;
                    rdnBalance = parsedData.rdnBalance;
                    isTransactionPending = parsedData.isTransactionPending || false; 
                    hasMadeFirstPurchase = parsedData.hasMadeFirstPurchase || false; 
                    isWithdrawalPending = parsedData.isWithdrawalPending || false; // NEW
                    // console.log(`[Persist] Data pengguna ${currentUserId} berhasil dimuat.`);
                } else {
                    // Jika tidak ada data tersimpan, gunakan data awal dan simpan
                    lotOwned = INITIAL_STATE.lotOwned;
                    rdnBalance = INITIAL_STATE.rdnBalance;
                    isTransactionPending = INITIAL_STATE.isTransactionPending;
                    hasMadeFirstPurchase = INITIAL_STATE.hasMadeFirstPurchase; 
                    isWithdrawalPending = INITIAL_STATE.isWithdrawalPending; // NEW
                    saveData(); // Simpan data awal
                    // console.log(`[Persist] Menggunakan data default dan disimpan.`);
                }
            }
        }


        // FUNGSI UTAMA: MENGHITUNG DAN MEMPERBARUI SELURUH UI
        function updateUI() {
            // 1. Perhitungan Ulang
            const totalShares = lotOwned * 100;
            const portfolioValueRaw = totalShares * currentPrice; 
            const totalEquity = rdnBalance + portfolioValueRaw;

            // 2. Update Portofolio Card
            document.getElementById('lot-owned').textContent = `${lotOwned.toLocaleString('id-ID')} Lot`;
            document.getElementById('portfolio-value').textContent = formatRupiah(portfolioValueRaw);
            
            // 3. Update Profil Pengguna Card
            document.getElementById('rdn-cash-balance').textContent = formatRupiah(rdnBalance); 
            document.getElementById('profile-portfolio-value').textContent = formatRupiah(portfolioValueRaw);
            document.getElementById('total-equity-balance').textContent = formatRupiah(totalEquity); 

            // 4. Update Pending Status UI (Pembelian)
            if (isTransactionPending) {
                pendingStatusBox.classList.remove('hidden');
            } else {
                pendingStatusBox.classList.add('hidden');
            }
            
            // 5. Update Pending Status UI (Penarikan Dana)
            if (isWithdrawalPending) {
                withdrawalStatusBox.classList.remove('hidden');
            } else {
                withdrawalStatusBox.classList.add('hidden');
            }

            // 6. Update Tombol Jual/Sell Button State (Logika Penguncian Baru)
            const isUnlockedByRules = hasMadeFirstPurchase || rdnBalance > RDN_UNLOCK_THRESHOLD;
            
            if (lotOwned > 0 && isUnlockedByRules) {
                sellBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                sellBtn.classList.add('hover:bg-red-600');
            } else {
                sellBtn.classList.add('opacity-50', 'cursor-not-allowed');
                sellBtn.classList.remove('hover:bg-red-600');
            }
        }

        // FUNGSI INTI: MENANGANI LOGIKA PEMBELIAN & PENJUALAN
        function handleOrder(event) {
            event.preventDefault();
            
            if (!currentUserId) {
                showNotification("Anda harus Log In terlebih dahulu untuk melakukan transaksi.", false);
                return;
            }

            const action = submitButton.textContent.includes('Beli') ? 'Pembelian' : 'Penjualan';
            const price = parseInt(priceInput.value, 10);
            const lots = parseInt(lotsInput.value, 10);
            const totalNominal = price * lots * 100;

            let message = '';
            let isSuccess = true;

            if (action === 'Penjualan') {
                // --- LOGIKA PENJUALAN (IMMEDIATE EXECUTION) ---
                
                // Pastikan tombol tidak dikunci sebelum proses ini
                const isUnlockedByRules = hasMadeFirstPurchase || rdnBalance > RDN_UNLOCK_THRESHOLD;
                
                if (!isUnlockedByRules) {
                    // Logic ini seharusnya tidak tercapai jika listener bekerja, tapi sebagai fallback
                    message = "Penjualan saham akan berlaku jika user sudah melakukan pembelian saham pertama di aplikasi, atau saldo kas RDN Anda melebihi Rp 10 Juta.";
                    isSuccess = false;
                } else if (lots > lotOwned) {
                    message = `GAGAL: Lot yang dijual (${lots.toLocaleString('id-ID')} Lot) melebihi Lot yang dimiliki (${lotOwned.toLocaleString('id-ID')} Lot).`;
                    isSuccess = false;
                } else {
                    // Lakukan transaksi Penjualan yang Berhasil
                    lotOwned -= lots; 
                    rdnBalance += totalNominal; 
                    
                    // Reset status penarikan karena saldo RDN bertambah dari penjualan
                    isWithdrawalPending = false; 

                    message = `Order Penjualan ${lots.toLocaleString('id-ID')} Lot @ Rp ${price.toLocaleString('id-ID')} berhasil dieksekusi! Saldo Kas RDN bertambah sebesar ${formatRupiah(totalNominal)}.`;
                }

                if (isSuccess) {
                    updateUI(); 
                    saveData(); 
                }
                showNotification(message, isSuccess);
                hideModal();

            } else {
                // --- LOGIKA PEMBELIAN (Pembayaran via Transfer Manual) ---

                // 1. Validasi Lot Minimum (Sekarang universal: 800 Lot)
                if (lots < MIN_BUY_LOTS) {
                    message = `GAGAL: Pembelian awal wajib sejumlah ${MIN_BUY_LOTS.toLocaleString('id-ID')} Lot.`;
                    isSuccess = false;
                } 
                
                // 2. Jika Validasi Berhasil, Lanjutkan ke Flow Pembayaran
                if (isSuccess) {
                    startPaymentFlow(lots, price, totalNominal);
                } else {
                     showNotification(message, false);
                }
            }
        }
        
        // FUNGSI INTI: MENANGANI LOGIKA PENARIKAN DANA
        function handleWithdrawal(event) {
            event.preventDefault();

            if (!currentUserId) {
                showNotification("Anda harus Log In terlebih dahulu untuk melakukan penarikan dana.", false);
                return;
            }

            const amountInput = document.getElementById('withdrawalAmount');
            const amount = parseInt(amountInput.value, 10);
            
            let message = '';
            let isSuccess = true;

            if (isNaN(amount) || amount < minWithdrawal) {
                message = `GAGAL: Jumlah penarikan minimal adalah ${formatRupiah(minWithdrawal)}.`;
                isSuccess = false;
            } else if (amount > rdnBalance) {
                message = `GAGAL: Saldo RDN tidak mencukupi. Penarikan ${formatRupiah(amount)} melebihi Saldo RDN ${formatRupiah(rdnBalance)}.`;
                isSuccess = false;
            } else {
                // Lakukan penarikan
                rdnBalance -= amount; 
                
                // NEW: Set status penarikan tertunda
                isWithdrawalPending = true;

                message = `Penarikan dana sebesar ${formatRupiah(amount)} berhasil! Dana akan ditransfer ke rekening ${USER_NAME} (${currentUserId}) dalam 1x24 jam kerja.`;
            }

            if (isSuccess) {
                updateUI();
                saveData(); // SIMPAN DATA SETELAH BERHASIL PENARIKAN (termasuk isWithdrawalPending)
                amountInput.value = ''; 
            }
            closeWithdrawalModal();
            showNotification(message, isSuccess);
        }

        // ** FUNGSI FLOW PEMBAYARAN **
        
        // Helper: Format Waktu (HH:MM:SS)
        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        
        function startPaymentFlow(lots, price, nominal) {
            hideModal(); // Sembunyikan Order Modal
            
            // Perbarui konten Modal Pembayaran
            paymentAmountElement.textContent = formatRupiah(nominal);
            document.getElementById('paymentBank').textContent = PAYMENT_BANK;
            document.getElementById('paymentAccount').textContent = PAYMENT_ACCOUNT;
            document.getElementById('paymentRecipient').textContent = PAYMENT_RECIPIENT;
            
            // Tampilkan Modal Pembayaran
            paymentModal.classList.remove('hidden');

            // Mulai hitungan mundur (1 jam)
            let duration = 60 * 60; // 1 jam dalam detik
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            function runTimer() {
                if (duration <= 0) {
                    clearInterval(timerInterval);
                    paymentTimerElement.textContent = "00:00:00";
                    showNotification("Waktu pembayaran telah habis. Order dibatalkan.", false);
                    closePaymentModal();
                } else {
                    paymentTimerElement.textContent = formatTime(duration);
                    duration--;
                }
            }

            runTimer();
            timerInterval = setInterval(runTimer, 1000);
        }

        function closePaymentModal() {
            paymentModal.classList.add('hidden');
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        /**
         * FUNGSI KRITIS: Menangani konfirmasi transfer dari user.
         * HANYA MENCATAT STATUS PENDING, TIDAK MENGUBAH NILAI PORTOFOLIO.
         */
        function handlePaymentConfirmation() {
            // 1. Bersihkan timer pembayaran transfer
            closePaymentModal(); 

            // 2. Set Status Transaksi Pending Permanen
            isTransactionPending = true;
            // 3. Set Status Pembelian Pertama Berhasil/Dikonfirmasi
            hasMadeFirstPurchase = true; 
            
            // 4. Simpan status 
            saveData(); 

            // 5. Perbarui UI untuk menampilkan kotak status dan tombol jual
            updateUI(); 

            // 6. Tampilkan Notifikasi
            showNotification("Transfer dikonfirmasi! Transaksi Anda telah masuk antrian kliring. Nilai portofolio Anda tidak akan berubah sampai status kliring selesai (diluar simulasi ini).", true);
        }
        // ** END FUNGSI FLOW PEMBAYARAN **


        // Helper: Copy to Clipboard
        function copyToClipboard(text, fieldName) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showNotification(`${fieldName} berhasil disalin!`, true);
            } catch (err) {
                showNotification(`Gagal menyalin ${fieldName}.`, false);
            }
            document.body.removeChild(tempInput);
        }
        window.copyToClipboard = copyToClipboard; 


        // ** FUNGSI AUTHENTICATION **

        function showAppContent(show) {
            mainContent.classList.toggle('hidden', !show);
            loginModal.classList.toggle('hidden', show);
        }

        function updateAuthUI() {
            if (currentUserId) {
                // Logged In State
                document.getElementById('user-name').textContent = USER_NAME; 
                document.getElementById('user-id').textContent = currentUserId;
                authStatusText.textContent = "Log Out";
                authStatusButton.classList.remove('bg-gray-500');
                authStatusButton.classList.add('bg-red-500', 'hover:bg-red-600');
                showAppContent(true);
            } else {
                // Logged Out State
                document.getElementById('user-name').textContent = "Pengguna Anonim";
                document.getElementById('user-id').textContent = "---";
                authStatusText.textContent = "Log In";
                authStatusButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                authStatusButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                showAppContent(false);
            }
        }
        
        function handleAuthAction() {
            if (currentUserId) {
                // Log Out Logic: data tetap tersimpan di LocalStorage
                
                startTransition(() => {
                    currentUserId = null;
                    // Reset state in-memory (tapi data di LocalStorage aman)
                    lotOwned = INITIAL_STATE.lotOwned; 
                    rdnBalance = INITIAL_STATE.rdnBalance; 
                    isTransactionPending = INITIAL_STATE.isTransactionPending;
                    hasMadeFirstPurchase = INITIAL_STATE.hasMadeFirstPurchase;
                    isWithdrawalPending = INITIAL_STATE.isWithdrawalPending; // NEW
                    
                    updateAuthUI();
                    updateUI();
                    showNotification("Berhasil Log Out. Data Anda tersimpan dan akan dimuat saat Log In kembali.", false);
                    loginModal.classList.remove('hidden'); // Show login screen after logout
                }, 1500); // Jeda 1.5 detik
                
            } else {
                // Log In Prompt: show the modal if the user is already on the page
                loginModal.classList.remove('hidden');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // Validasi hardcoded credentials
            if (phone === CORRECT_PHONE && password === CORRECT_PASSWORD) {
                
                // Panggil transisi sebelum Log In sukses
                startTransition(() => {
                    currentUserId = RDN_ACCOUNT_NUMBER; 
                    loadData(); // MUAT DATA TERSIMPAN
                    updateAuthUI(); // Update header and show content
                    updateUI(); // Load initial data into cards
                    showNotification("Login Berhasil! Selamat datang, " + USER_NAME + ". Data Anda telah dimuat.", true);
                    loginModal.classList.add('hidden'); // Hide login modal
                }, 1500); // Jeda 1.5 detik
                
            } else {
                // KODE KRITIS: Memberi tahu kegagalan tanpa memberi tahu kredensial
                showNotification("Nomor HP atau Password salah. Coba lagi.", false);
            }
        }

        // ** FUNGSI UI & NOTIFIKASI YANG DITINGKATKAN **
        
        function showNotification(message, isSuccessParam = null) {
            // 1. Reset state dan konten
            notificationBox.textContent = message;
            notificationBox.classList.remove('opacity-100', 'bg-blue-500', 'bg-green-500', 'bg-red-500');
            notificationBox.classList.add('opacity-0'); // Pastikan mulai dari 0

            const isSuccess = isSuccessParam !== null ? isSuccessParam : (message.includes('berhasil') || message.includes('dieksekusi') || message.includes('diproses'));

            // 2. Set warna yang benar
            notificationBox.classList.add(isSuccess ? 'bg-green-500' : 'bg-red-500');

            // 3. Tampilkan elemen (hapus 'hidden')
            notificationBox.classList.remove('hidden');
            
            // 4. Double requestAnimationFrame untuk menjamin transisi terpicu
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // Start the transition in the next available render cycle
                    notificationBox.classList.remove('opacity-0');
                    notificationBox.classList.add('opacity-100');
                });
            });

            // 5. Sembunyikan setelah 5 detik
            setTimeout(() => {
                // Mulai transisi fade out
                notificationBox.classList.remove('opacity-100');
                notificationBox.classList.add('opacity-0');

                // Setelah transisi selesai (300ms), sembunyikan sepenuhnya
                setTimeout(() => {
                    notificationBox.classList.add('hidden');
                }, 300); // Sesuai dengan duration-300 di CSS
            }, 5000); // Durasi tampilan: 5 detik
        }
        // ** AKHIR FUNGSI NOTIFIKASI YANG DITINGKATKAN **

        function updateModalLotLabel(action) {
            const isBuy = action === 'Beli';
            
            if (isBuy) {
                minLotWarning.textContent = `Pembelian wajib minimal ${MIN_BUY_LOTS.toLocaleString('id-ID')} lot.`; // Update text for clarity
                minLotWarning.classList.remove('hidden');
                buyMethodText.classList.remove('hidden');
                lotsInput.setAttribute('min', MIN_BUY_LOTS);
                lotsInput.value = MIN_BUY_LOTS; // Set default ke minimum
            } else {
                minLotWarning.classList.add('hidden');
                buyMethodText.classList.add('hidden');
                lotsInput.setAttribute('min', 1);
                // Ketika menjual, default value adalah lot yang dimiliki jika lotOwned > 0
                lotsInput.value = lotOwned > 0 ? lotOwned : 1; 
                lotsInput.setAttribute('max', lotOwned > 0 ? lotOwned : 1);
            }
        }

        function showModal(action) {
            if (!currentUserId) {
                 showNotification("Anda harus Log In terlebih dahulu untuk melakukan transaksi.", false);
                 return;
            }
            modalTitle.textContent = `${action} Saham GIAA`;
            submitButton.textContent = `Konfirmasi ${action}`;
            submitButton.className = action === 'Beli' 
                ? 'py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-200' 
                : 'py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200';
            
            priceInput.value = currentPrice;
            orderTypeSelect.value = 'Limit'; 
            priceInput.readOnly = false;
            priceInput.classList.remove('bg-gray-100');
            
            updateModalLotLabel(action); 
            orderModal.classList.remove('hidden'); 
        }

        function hideModal() {
            orderModal.classList.add('hidden'); 
        }

        function openWithdrawalModal() {
            if (!currentUserId) {
                 showNotification("Anda harus Log In terlebih dahulu untuk mengakses menu dana.", false);
                 return;
            }

            document.getElementById('modal-user-name').textContent = USER_NAME;
            document.getElementById('modal-user-id').textContent = currentUserId;
            document.getElementById('modal-rdn-balance').textContent = formatRupiah(rdnBalance);
            // Default value for withdrawal amount
            document.getElementById('withdrawalAmount').value = rdnBalance >= 100000 ? 100000 : (rdnBalance > 0 ? rdnBalance : 0); 
            
            withdrawalModal.classList.remove('hidden');
        }

        function closeWithdrawalModal() {
            withdrawalModal.classList.add('hidden');
        }

        // Event listener untuk Market Order
        orderTypeSelect.addEventListener('change', (e) => {
            const isMarket = e.target.value === 'Market';
            priceInput.readOnly = isMarket;
            if (isMarket) {
                priceInput.value = currentPrice;
                priceInput.classList.add('bg-gray-100');
            } else {
                priceInput.classList.remove('bg-gray-100');
            }
        });

        // ** INISIALISASI SAAT STARTUP DAN ATTACH LISTENERS **
        window.onload = function() {
            // Isi data statik 
            priceElement.textContent = currentPrice;
            changeElement.textContent = `+${priceChange} (+${percentChange}%)`;

            // Initialize UI (It will show the login modal by default)
            updateAuthUI(); 
            updateUI(); 
            
            // Tampilkan modal login jika belum login
            if (!currentUserId) {
                 loginModal.classList.remove('hidden');
            }

            // --- ATTACH EVENT LISTENERS ---
            
            // Auth Actions
            authStatusButton.addEventListener('click', handleAuthAction);
            loginForm.addEventListener('submit', handleLogin);
            
            // Trading Actions
            sellBtn.addEventListener('click', () => {
                const isUnlockedByRules = hasMadeFirstPurchase || rdnBalance > RDN_UNLOCK_THRESHOLD;
                
                if (!isUnlockedByRules) {
                    // Notifikasi Spesifik dari User
                    const message = "Penjualan saham akan berlaku jika user sudah melakukan pembelian saham pertama di aplikasi, atau saldo kas RDN Anda melebihi Rp 10 Juta.";
                    showNotification(message, false);
                } else if (lotOwned === 0) {
                     // Jika sudah unlock, tapi lot 0
                     showNotification("GAGAL: Anda tidak memiliki Lot GIAA untuk dijual.", false);
                } else {
                    // Izinkan penjualan jika lot dimiliki DAN unlock
                    showModal('Jual');
                }
            });

            buyBtn.addEventListener('click', () => showModal('Beli')); 
            withdrawalBtn.addEventListener('click', openWithdrawalModal); 

            // Form Submissions
            orderForm.addEventListener('submit', handleOrder);
            withdrawalForm.addEventListener('submit', handleWithdrawal);
            
            // Modal Closures
            cancelOrderBtn.addEventListener('click', hideModal);
            cancelWithdrawalBtn.addEventListener('click', closeWithdrawalModal);

            // Payment Confirmation (THIS IS THE CRITICAL CHANGE)
            paymentConfirmBtn.addEventListener('click', handlePaymentConfirmation);

            // Handle modal overlay clicks
            orderModal.addEventListener('click', hideModal);
            withdrawalModal.addEventListener('click', closeWithdrawalModal);
            paymentModal.addEventListener('click', closePaymentModal);

            // Prevent closing when clicking inside the modal content
            orderModalContent.addEventListener('click', (e) => e.stopPropagation());
            withdrawalModalContent.addEventListener('click', (e) => e.stopPropagation());
            paymentModalContent.addEventListener('click', (e) => e.stopPropagation());
        }
    </script>
</body>
</html>
